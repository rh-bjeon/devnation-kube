= Blue/Green ë°°í¬

Kubernetesì—ì„œëŠ” ë ˆì´ë¸”(Labels)ì„ ì´ìš©í•´ íŠ¹ì • íŒŒë“œì— íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ì´ë¥¼ í†µí•´ ë¸”ë£¨-ê·¸ë¦° ë°°í¬(Blue-Green Deployment)ë‚˜ A/B í…ŒìŠ¤íŠ¸ ë˜í•œ ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Blue/Green ë°°í¬ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª…ì€ https://martinfowler.com/bliki/BlueGreenDeployment.html[ì—¬ê¸°]ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


== ì‚¬ì „ êµ¬ì„±

ì´ë²ˆ ì‹¤ìŠµì—ì„œëŠ” 2ê°€ì§€ ë²„ì „ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë™ì‹œì— ì‹¤í–‰ë˜ë„ë¡ ë°°í¬í•˜ê³ , íŠ¸ë˜í”½ì„ ìƒˆ ë²„ì „ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ì „í™˜í•´ë³´ê² ìŠµë‹ˆë‹¤.

ì‹¤ìŠµ ì§„í–‰ ì „ì— ì˜¬ë°”ë¥¸ í”„ë¡œì íŠ¸ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

* *Terminal#1ì—ì„œ ì‘ì—…*

[#kubectl-deploy-app]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc new-project bg-%userid%
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
namespace/bg-%userid% created
----

NOTE: `oc new-project bg-%userid%` : bg-%userid%ë¼ëŠ” ìƒˆ í”„ë¡œì íŠ¸(ë„¤ì„ìŠ¤í˜ì´ìŠ¤)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

[#kubectl-deploy-app]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc project bg-%userid%
----

[.console-output]
[source,bash,subs="+macros,+attributes"]
----
Now using project "bg-%userid%" on server "https://172.30.0.1:443".
----

NOTE: `oc project bg-%userid%` : í˜„ì¬ í™œì„±í™”ëœ ì»¨í…ìŠ¤íŠ¸ì˜ ê¸°ë³¸ í”„ë¡œì íŠ¸ë¥¼ bg-%userid%ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.



ë‹¤ë¥¸ ê²ƒì´ ë°°í¬ë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.:

[#no-resources-blue-green]
[.console-input]
[source, bash]
----
oc get all
----

[.console-output]
[source,bash]
----
No resources found in bg-%userid% namespace.
----

ìƒ˜í”Œ ì• í”Œë¦¬ì¼€ì´ì…˜ mybootë¥¼ ë°°í¬í•´ë³´ê² ìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ í˜¸ì¶œ ì‹œ,

V1ì€ `Aloha from Spring Boot!` ë©”ì‹œì§€ë¥¼,
V2ëŠ” `Bonjour from Spring Boot!` ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤. 

`myboot` V1 ë°°í¬:

[#deploy-v1-blue-green]
[.console-input]
[source, bash]
----
cat <<EOF | oc apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: myboot
  name: myboot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myboot
  template:
    metadata:
      labels:
        app: myboot
    spec:
      containers:
      - name: myboot
        image: quay.io/rhdevelopers/myboot:v1
        ports:
          - containerPort: 8080
        resources:
          requests: 
            memory: "300Mi" 
            cpu: "250m" # 1/4 core
          limits:
            memory: "900Mi"
            cpu: "1000m" # 1 core
EOF
----

Podì˜ ë³µì œë³¸ ê°œìˆ˜ë¥¼ 2ê°œë¡œ ëŠ˜ë¦½ë‹ˆë‹¤.

[#scale-v1-blue-green]
[.console-input]
[source, bash]
----
oc scale deployment/myboot --replicas=2
----


ì„œë¹„ìŠ¤ ë°°í¬:

[#deploy-service-blue-green]
[.console-input]
[source, bash]
----
cat <<EOF | oc apply -f -
apiVersion: v1
kind: Service
metadata:
  name: myboot
  labels:
    app: myboot
spec:
  ports:
  - name: http
    port: 8080
  selector:
    app: myboot
EOF
----


* *Terminal#2ì—ì„œ ì‘ì—…*

[#kubectl-deploy-app]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc project bg-%userid%
----

ì‹¤ì‹œê°„ìœ¼ë¡œ pod ìƒíƒœ í™•ì¸ ( `show-labels` ì˜µì…˜ì„ í•¨ê»˜ ì‚¬ìš©):

[#labels-v1-blue-green]
[.console-input]
[source, bash]
----
watch oc get pods --show-labels
----

* *Terminal#3ì—ì„œ ì‘ì—…*

[#kubectl-deploy-app]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc project bg-%userid%
----

Serviceì˜ Cluster IPë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

[.console-input]
[source,bash,subs="+macros,+attributes"]
----
IP=$(oc get service myboot -o jsonpath="{.spec.clusterIP}")
----


[.console-input]
[source,bash,subs="+macros,+attributes"]
----
PORT=$(oc get service myboot -o jsonpath="{.spec.ports[*].port}")
----


Poll the endpoint:

[#poll-endpoint]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
while true
do curl $IP:$PORT
sleep 0.8
done
----

[.console-output]
[source,bash]
----
Aloha from Spring Boot! 2 on myboot-76b66dc545-s6j7c
Aloha from Spring Boot! 1 on myboot-76b66dc545-nqx59
Aloha from Spring Boot! 2 on myboot-76b66dc545-nqx59
----


`myboot` V2 ë°°í¬:
* my-boot-nextë¼ëŠ” ìƒˆë¡œìš´ ë²„ì „(v2) ë°°í¬
* my-boot-nextëŠ” ê¸°ì¡´ `v1`ê³¼ ë‹¤ë¥¸ ë ˆì´ë¸”ì„ ì‚¬ìš©í•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë¨

[#deploy-v2-blue-green]
[.console-input]
[source, bash]
----
cat <<EOF | oc apply -f -
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: myboot-next
  name: myboot-next
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myboot-next
  template:
    metadata:
      labels:
        app: myboot-next
    spec:
      containers:
      - name: myboot
        image: quay.io/rhdevelopers/myboot:v2
        ports:
          - containerPort: 8080
        resources:
          requests: 
            memory: "300Mi" 
            cpu: "250m" # 1/4 core
          limits:
            memory: "900Mi"
            cpu: "1000m" # 1 core
EOF
----

ìƒˆ Pod/ë°°í¬ì— ìƒˆ ì½”ë“œê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

[#exec-v2-blue-green]
[.console-input]
[source, bash]
----
PODNAME=$(oc get pod -l app=myboot-next -o name)
----

[#exec-v2-blue-green]
[.console-input]
[source, bash]
----
oc exec -it $PODNAME -- curl localhost:8080
----

NOTE: Pod ìƒì„± ì§í›„ ìœ„ì˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—ëŸ¬ ë°œìƒ ì‹œ ì ì‹œ í›„ì— ë‹¤ì‹œ ì‹œë„í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

V2 ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ Bonjourë¡œ ì‹œì‘ë˜ëŠ” ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.

[.console-output]
[source,bash]
----
Bonjour from Spring Boot! 1 on myboot-next-66b68c6659-ftcjr
----

ì´ì œ Serviceê°€ ìƒˆ Pod(myboot-next)ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ì—…ë°ì´íŠ¸í•˜ê³  Greenìœ¼ë¡œ ì „í™˜í•˜ì„¸ìš”.

[#patch-service-green]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc patch svc/myboot -p '{"spec":{"selector":{"app":"myboot-next"}}}'
----

ê·¸ë¦¬ê³  Terminal#3ì„ í™•ì¸í•˜ë©´, ì•„ë˜ì™€ ê°™ì´ V2 ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ë¼ìš°íŒ…ë˜ë©´ì„œ ë©”ì‹œì§€ê°€ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

[.console-output]
[source,bash]
----
Aloha from Spring Boot! 240 on myboot-d78fb6d58-929wn
Bonjour from Spring Boot! 2 on myboot-next-66b68c6659-ftcjr
Bonjour from Spring Boot! 3 on myboot-next-66b68c6659-ftcjr
Bonjour from Spring Boot! 4 on myboot-next-66b68c6659-ftcjr
----


ë‹¤ì‹œ ì´ì „ ë²„ì „ìœ¼ë¡œ ëŒì•„ê°€ê³  ì‹¶ë‹¤ë©´,
ì´ì „ Pod(myboot)ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ì„œë¹„ìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  Blueë¡œ ì „í™˜í•©ë‹ˆë‹¤.

[#patch-service-blue]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc patch svc/myboot -p '{"spec":{"selector":{"app":"myboot"}}}'
----

[.console-output]
[source,bash]
----
Bonjour from Spring Boot! 17 on myboot-next-66b68c6659-ftcjr
Aloha from Spring Boot! 257 on myboot-d78fb6d58-vqvlb
Aloha from Spring Boot! 258 on myboot-d78fb6d58-vqvlb
----

== ì •ë¦¬

âœ… ë¸”ë£¨-ê·¸ë¦° ë°°í¬ì˜ í•µì‹¬:

* `oc patch` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ë¹ ë¥´ê²Œ ë²„ì „ ì „í™˜ ê°€ëŠ¥
* ë¬´ì¤‘ë‹¨ ë°°í¬(Zero Downtime Deployment) ê°€ëŠ¥
* í•„ìš”í•  ê²½ìš° ê¸°ì¡´ ë²„ì „(v1) ì œê±° ê°€ëŠ¥

ğŸ’¡ ë¸”ë£¨-ê·¸ë¦° ë°°í¬ëŠ” ë¹ ë¥´ê³  ê°„ë‹¨í•œ ë°°í¬ ì „ëµìœ¼ë¡œ, ìš´ì˜ ì¤‘ì¸ ì„œë¹„ìŠ¤ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šê³  ì‹ ê·œ ë²„ì „ì„ ë°°í¬í•  ìˆ˜ ìˆëŠ” íš¨ê³¼ì ì¸ ë°©ë²•ì…ë‹ˆë‹¤. 



== Clean Up

ì‹¤ìŠµì„ ë§ˆì³¤ìœ¼ë©´ ìƒì„±í–ˆë˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. 

[#clean]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc delete service myboot
----


[#clean]
[.console-input]
[source,bash,subs="+macros,+attributes"]
----
oc delete deployment myboot myboot-next
----
